<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="all" name="Compile and build java classes plus jar archives">
	
	<property name="ver" value="2.4" />
	<property name="imageviewer.jar.name" value="ImageViewer.jar" />
	<property name="javapeg.jar.name"     value="JavaPEG.jar" />
	
	<property name="zip_src.name"         value="JavaPEG_${ver}_Src.zip" />
	
	<property name="imageviewer.main.class" value="moller.imageviewer.StartImageViewer" />
	<property name="javepeg.main.class"     value="moller.javapeg.StartJavaPEG" />

	<target name="all" depends="clean_build, build, create_jar, create_imageviewer_jar, create_release, create_release_src" />

	<target name="clean_build">
		<delete failonerror="no">
			<fileset dir="build">
				<include name="**" />
			</fileset>
		</delete>
	</target>

	<target name="delete_build" description="Deleted the entire build folder">
		<delete failonerror="yes" dir="build" />
	</target>

	<target name="build" depends="clean_build">
		<mkdir dir="build" />
		<javac srcdir="src" destdir="build" target="1.6" debug="true">
			<classpath>
				<fileset dir="lib" includes="*.jar" />
			</classpath>
			<include name="moller/**" />
			<exclude name="**/unittest/**" />
		</javac>
		<copy todir="build" overwrite="true">
			<fileset dir="src">
				<include name="**/*.gif" />
				<include name="**/iso639.dat" />
				<include name="**/language.list" />
				<include name="**/language.en" />
				<include name="**/language.es" />
				<include name="**/language.sv" />
				<include name="**/layout.xml" />
				<include name="**/layout.xsd" />
				<include name="**/style.css" />
				<include name="**/conf.xml" />
				<include name="**/language.info" />
				<include name="**/layout.info" />
				<include name="**/style.info" />
				<include name="**/references" />
				<include name="**/thumbnail_overview" />
				<include name="**/user_manual_imagelist" />
				<include name="**/user_manual_overview" />
				<include name="**/user_manual_rename" />
				<include name="**/version_information" />
			</fileset>
		</copy>
	</target>

	<target name="create_jar" depends="build">
		<delete file="${javapeg.jar.name}" />
        <unjar src="lib/metadata-extractor-2.3.1.jar" dest="build" />
		<jar destfile="${javapeg.jar.name}" filesetmanifest="mergewithoutmain">
			<manifest>
				<attribute name="Main-Class" value="${javepeg.main.class}" />
				<attribute name="Class-Path" value="." />
			</manifest>
			<fileset dir="build">
				<exclude name="**/imageviewer/**" />
				<exclude name="**/test/**" />
				<exclude name="**/*.java" />
			</fileset>
		</jar>
	</target>
	
	<target name="create_imageviewer_jar" depends="build">
	        <delete file="${imageviewer.jar.name}" />
	        
	        <jar destfile="${imageviewer.jar.name}" filesetmanifest="mergewithoutmain">
	            <manifest>
	                <attribute name="Main-Class" value="${imageviewer.main.class}" />
	                <attribute name="Class-Path" value="${javapeg.jar.name}" />
	            </manifest>
	            <fileset dir="build">
	            	<exclude name="**/com/**" />
	            	<exclude name="**/javapeg/**" />
	            	<exclude name="**/util/**" />
	                <exclude name="**/test/**" />
	                <exclude name="**/*.java" />
	            </fileset>
	        </jar>
	    </target>
	
	<target name="create_release">
				
		<!-- Allows us to use the IzPack Ant task, standalone-compiler.jar added to Ant lib -->
		<taskdef name="izpack" 
			     classpath="lib/standalone-compiler.jar" 
			     classname="com.izforge.izpack.ant.IzPackTask"/>

		<!-- Replace version token in shortcut definition files -->
		<antcall target="replace_tokens" />
		
		<!-- Run installer build -->
		<echo message="Running IzPack to build the installer..."/>
		<izpack input="izpack/install.xml"
		        output="JavaPEG_${ver}_Install.jar"
		        installerType="standard"
		        inheritAll="true"
		        basedir="izpack"
		        compression="deflate"
		        compressionlevel="9"/>
		
		<!-- Restore version token in shortcut definition files -->
		<antcall target="restore_tokens" />

	</target>
		
	<target name="replace_tokens">
	    <replace file="izpack/shortcutSpec.xml" 
	       	     token="@ver@" 
	       	     value="${ver}" 
	       	     summary="yes"/>
	        
	    <replace file="izpack/Unix_shortcutSpec.xml"
	             token="@ver@"
	             value="${ver}"
	             summary="yes"/>
	</target>
	
	<target name="restore_tokens">
	    <replace file="izpack/shortcutSpec.xml" 
	             token="${ver}" 
	             value="@ver@" 
	             summary="yes"/>
	            
	    <replace file="izpack/Unix_shortcutSpec.xml"
	             token="${ver}"
	             value="@ver@"
	             summary="yes"/>
	</target>
		
	<target name="create_release_src" description="Packs all necessary files for the source code release into one zip archive">
	        <zip destfile="${zip_src.name}" update="false">
	            <fileset dir="./">
	                <include name="src/moller/**" />
	                <include name="build.xml" />
	                <include name="gpl.txt" />
	            	<include name="CHANGELOG.txt" />
	                <include name="TODO.txt" />
	                <include name="lib/metadata-extractor-2.3.1.jar" />
	            </fileset>
	        </zip>
	    </target>
</project>